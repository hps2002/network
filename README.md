# 计算机网络囫囵吞枣

## TCP/IP网络模型
### 应用层
常用协议：http、ftp、Telnet、DNS、SMTP等

数据单位为报文。发送方使用http等应用层协议将数据和信息封装成为报文传输到传输层。
应用层在用户态中进行工作，传输层、网络层、网络接口层在内核态；

### 传输层
传输层使用的协议是TCP协议和UDP协议

tcp和udp的区别：
* tcp面向可靠传输，udp面向不可靠传输
* tcp相对于udp拥有流量控制、超时重传、拥塞控制等
* udp相对于tcp的效率高很多，但是udp只负责发送数据包不保证数据包是否到达接收方手上

当数据传输超过MSS（TCP传输的最大报文长度）需要将数据包进行分块，每个分块称为TCP段。
分块的优势在于，某个分块在传输的时候丢失我们只需要重新转发那个分块，不需要重发所有的数据包。

接收数据包的时候，tcp协议通过设备端口进行应用的区分，每个进程都拥有不同的端口，使得tcp协议能准确的将数据包传输给应用。udp也是通过端口号进行传输。

### 网络层

网络层的作用是将传输层封装好的数据段，从一台设备传输到另一台设备。

网络层使用的协议是ip协议：
将传输层封装好的报文作为数据部分，在前面添加ip头部形成ip报文，如果ip报文超过MTU（以太网中大小为1500字节），就会再次分片；

ip协议：
ip头部 + (tcp头部 + (应用层报文))

网络层进行传递的时候通过设备的ip地址进行传输
ip地址一般采用的是ipv4协议或者ipv6协议。

ipv4协议中：主要由32位的二进制数组成。由网络号和主机号组成：网络号负责表示当前的ip地址属于哪个子网、主机号表示当前设备属于子网下的哪台主机。

通过子网掩码求出网络号和主机号；

ip协议在传输的过程中主要通过路由协议进行路径的选取。在ip协议中：IP地址告诉当前数据包要往哪个方向走，路由协议则告诉当前数据包要走哪一条路。

### 网络接口层
网络接口层将网络层封装下来的数据再次进行包装，即在ip协议报文前面加上一个MAC地址<br>
MAC地址是每台主机的标识，以太网判断网络数据包的目的地和ip地址的方式不同，所以要通过MAC头部进行以太网之间的通讯。

网络数据包在底层设备间进行传输的过程：
网络数据包通过网卡中的驱动程序将数据转化成电平信号，通过网线在以太网上进行传播

首先到达交换机，交换机先通过校验MAC地址检查是否为自己接收的数据包，如果不是的话就丢弃；如果是的话就接收，接收之后将MAC头部解析，重新封装MAC头部，通过目的ip地址查找应该交付哪个端口转发，如果交换机的缓存中找不到对应端口转发，那么将进行广播， 如果找到端口则重新封装MAC头部，其中的目的MAC地址通过ARP协议获取。

然后到达路由器，路由器也是先校验MAC地址，查看是否为自己接收的数据包，如果是的话就将数据包进行解析，根据目的IP地址要从哪个端口转发，如果在路由表中找不到的话从网关进行转发，在这里的话也是需要重新封装MAC头部的，源目的地址也是通过ARP协议获取。如果在一个路由器的下一跳网关为空的话说明网络数据包的目的地已经到了。

然后传输到另外一台客户端中通过网卡接收数据
在整个过程中，数据包的的源IP地址和目的IP地址没有改变，改变的只有底层的MAC头部，帧起始标识符，帧结束标识符，数据校验码。

## 输入网址之后做了什么？

### url解析
在浏览器输入一个网址之后首先浏览器要对这个网址进行解析，得到其中隐含的信息，包括：访问数据的协议、服务器域名、请求文件路径；

例如：http://www.huangpeishen.com/index/page1/home.html
其中：
* http &emsp; 表示访问数据的协议
* www.huangpeishen.com &emsp;表示访问的服务器
* /index/page/home.html &emsp;表示请求文件的路径

**如果没有后面的请求文件路径**就会返回服务器的默认页面，一般是服务器的首页

### 生成请求报文
如果是http协议的话会生成http请求信息向服务器请求数据<br>
http协议有两种请求报文:**Get报文**和**Post报文**

请求报文由**请求行** + **消息头** + **消息体组成**
* 请求行：方法 + sp + URL + sp + 版本 + cr + lf
* 消息头：首部字段名 + sp + 字段值 + cr + lf
····
首部字段名 + sp + 字段值 + cr + lf
* cr + lf
* 消息体：数据

响应报文由**状态行** + **消息头** + **消息体**
* 状态行：版本 + 状态码 + 短语
* 消息头：首部字段名 + 字段值
首部字段名 + 字段值
* 消息体：数据

### 域名解析
生成http请求消息之后，将http报文委托操作系统转发给服务器

通过DNS服务器查询获取服务器的IP地址

* 域名解析：
域名中使用**句点**进行分离域名，越靠右的域名层级越高
在实际域名中还有一个`.`，比如`www.huangpeishen.com.`其中的`.`就是根域，下一层就是.com, 在下一层就是.huangpeishen

```
DNS服务器查询服务器域名对应的IP地址流程：
1.首先向本地的域名服务器的缓存中查找是否存在当前域名的ip地址
2.如果本地服务器中不存在当前域名的ip地址，本地DNS服务器就要去根域名服务器请求当前域名的ip地址
3.根域名服务器不会直接给出具体的ip地址，它会给出下一层域名的DNS服务器ip地址，让你去下一层DNS服务器中寻找
4.当你再次进入下一层服务器的时候，它也不会直接给出具体的ip地址，它也是给出下一层DNS服务器的地址，让你再下一层的寻找
5.如此循环，一直来到权威DNS服务器的时候，才能获得当前请求的IP地址。权威DNS服务器就是网址中的".huangpeishen"，因为这才是IP地址的出处。权威DNS服务器将IP地址返回给本地DNS服务器，本地DNS服务器再返回给客户端
```

### 交付协议栈
获取到IP地址之后将http传输工作交付操作系统中的协议栈，通过tcp协议进行传输
tcp协议封装好http报文之后交付ip协议封装

通过tcp传输数据之前要建立tcp连接 -> 三次握手
建立好连接之后才能通过tcp协议对应用层的报文进行数据传输

tcp封装好的报文来到要再网络上传输要通过ip协议进行传输，即再tcp数据报的前面加上一个ip头部，IP头部里面有源IP地址、目的IP地址。
IP协议有IPv4、ipv6协议

### 两点之间传输

ip协议封装好的数据报要在设备之间传输需要在前面加上一个mac头部，用于两点之间的网络包传递
发送方的mac地址直接使用读取网卡中的mac地址即可
接收方的mac地址要使用arp协议进行ip广播，获得对应ip地址的MAC地址；
如果IP数据报超出MTU的话要进行切分。

最后数据包通过网卡中的驱动程序转化成电信号，在开头加上报头和起始帧分节符，后面加上检验序列。

### 数据包传输
数据从客户端出来之后首先到达交换机，在交换机中查询MAC地址表转发到路由器上，在路由器上根据路由转发协议，一步一步的转发，使得网络包到达终点。

传输的传输的过程中网络包中变化的只有MAC头部，源ip和目标ip是始终不变的。

### 获取服务器资源（服务器应答报文传递）
最终服务器接收客户端传来的数据包

通过一层一层的解析，确认MAC地址，确认ip地址、确认tcp序列号和端口，将数据包转发给正在监听这个端口的http进程。

通过客户端的http报文请求，返回对应的资源文件。如果客户端访问一个页面，服务器将这个页面封装在http的响应报文中，响应报文经过tcp封装，IP封装，MAC封装，最后经过和请求报文一样的传输过程，到达客户端解析并渲染在客户端主机上。

****************************************************************************************************
总结：在浏览器中输入网址之后，首先要进行的是
* url解析，通过url解析知道用的是什么协议，哪个服务器，请求什么资源文件
* 封装请求报文，向服务器发送请求
* 查找DNS服务器，获取服务器的ip地址，客户端首先向本地DNS服务器询问是否缓存当前网址的ip地址，如果没有则依次从根域名服务器到权威服务器进行查找，返回ip地址；
* 封装tcp报文，添加上源端口和目的端口以及tcp报文的序列号。在发送网络数据包之前首先要建立tcp连接(三次握手)
* 封装ip报文
* 封装MAC头部，通过arp进行获取目的MAC的报文
* 在网络设备上进行传输，
* 服务端接收http请求，封装客户端请求资源生成响应报文回传客户端。


